<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ë¶„ì„ ê²°ê³¼</title>
  <style>
    body { font-family: sans-serif; margin: 2em; }
    h1 { color: #333; }
    h2 { margin-top: 32px; }
    table { width: 100%; border-collapse: collapse; margin-top: 1em; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: #f2f2f2; }
    .group-box { border: 1px solid #ccc; padding: 10px; margin-bottom: 20px; }
    .group-title { font-weight: bold; margin-bottom: 10px; }
    .group-images, .tagged, .thumbs { display: flex; flex-wrap: wrap; gap: 8px; }
    .group-images img, .tagged img, .thumbs img { width: 150px; height: 100px; object-fit: cover; border: 1px solid #ddd; }
    .tagged img { border: 2px solid #5cb85c; }
    .chip { display:inline-block; padding:2px 8px; background:#eef2ff; border-radius:999px; font-size:12px; margin-right:6px }
    .muted { color:#666; font-size:12px; }
    .card { border:1px solid #e5e7eb; border-radius:8px; padding:10px; margin:10px 0; }
    .row { display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .kv { font-family: ui-monospace, Menlo, Consolas, monospace; font-size:12px; margin-top:4px; }
  </style>
</head>
<body>
  <h1>ğŸ” ë¶„ì„ ê²°ê³¼</h1>

  {# ----------------------------------------------------
     1) íë¦¼ ì‚¬ì§„ (ë ˆê±°ì‹œ/ì‹ ê·œ í‚¤ ëª¨ë‘ ì§€ì›)
     ì „ë‹¬ ì˜ˆì‹œ:
       results = quality["results"]
     ---------------------------------------------------- #}
  <h2>ğŸ“· íë¦¼ ì‚¬ì§„</h2>
  {% if results %}
    {% set blur_rows = [] %}
    {% for r in results %}
      {% set is_blur = r.get('Blur', r.get('is_blur')) %}
      {% if is_blur %}
        {% set _ = blur_rows.append(r) %}
      {% endif %}
    {% endfor %}

    {% if blur_rows %}
      <table>
        <thead>
          <tr><th>íŒŒì¼ëª…</th><th>íë¦¼ ì—¬ë¶€</th><th>Laplacian ê°’</th></tr>
        </thead>
        <tbody>
          {% for r in blur_rows %}
            {% set fname = r.get('File', r.get('name')) %}
            {% set lap = r.get('LaplacianVar', r.get('laplacian_variance')) %}
            <tr>
              <td>{{ fname }}</td>
              <td>íë¦¼</td>
              <td>{{ "%.2f"|format(lap|float) }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p>íë¦¼ ì‚¬ì§„ ì—†ìŒ</p>
    {% endif %}
  {% else %}
    <p>íë¦¼ ì‚¬ì§„ ì—†ìŒ</p>
  {% endif %}

  {# ----------------------------------------------------
     2) ìœ ì‚¬ ì‚¬ì§„ ê·¸ë£¹ (ìƒˆ groups ë˜ëŠ” groups_legacy)
     ì¶”ê°€ë¡œ album_images(name->url) ìˆìœ¼ë©´ ì›ë³¸ URLë¡œ í‘œì‹œ
     ì „ë‹¬ ì˜ˆì‹œ:
       groups = quality["groups"]
       groups_legacy = quality.get("groups_legacy")
       album_images = { name: url, ... }  # optional
     ---------------------------------------------------- #}
  <h2>ğŸ§© ìœ ì‚¬ ì‚¬ì§„ ê·¸ë£¹</h2>
  {% set show_groups = groups if groups else [] %}
  {% if not show_groups and groups_legacy %}
    {% set show_groups = groups_legacy | map('list') | list
      | map('tojson') %}{% endset %}
  {% endif %}

  {% if groups or groups_legacy %}
    {% if groups %}
      {# ìƒˆ êµ¬ì¡°: [{group_id, images:[...], similarities:[...]}] #}
      {% for g in groups %}
        <div class="group-box">
          <div class="group-title">ê·¸ë£¹ #{{ g.group_id }} ({{ g.images|length }}ì¥)</div>
          <div class="group-images">
            {% for name in g.images %}
              {% if album_images and album_images.get(name) %}
                <img src="{{ album_images.get(name) }}" alt="{{ name }}">
              {% else %}
                {# ì„œë²„ì— ì €ì¥ëœ íŒŒì¼ëª…ì´ë¼ë©´ ê¸°ì¡´ ë¼ìš°íŠ¸ ì¬ì‚¬ìš© #}
                <img src="{{ url_for('uploaded_source_file', filename=name) }}" alt="{{ name }}">
              {% endif %}
            {% endfor %}
          </div>
          {% if g.similarities %}
            <div class="kv muted">
              ìœ ì‚¬ìŒ ì˜ˆ: 
              {% for s in g.similarities[:5] %}
                {{ s.image1 }}~{{ s.image2 }} ({{ "%.2f"|format(s.similarity) }}){% if not loop.last %}, {% endif %}
              {% endfor %}
              {% if g.similarities|length > 5 %} â€¦{% endif %}
            </div>
          {% endif %}
        </div>
      {% endfor %}
    {% else %}
      {# ë ˆê±°ì‹œ: [["img1","img2"], ...] #}
      {% for group in groups_legacy %}
        <div class="group-box">
          <div class="group-title">ìœ ì‚¬ ì‚¬ì§„ ê·¸ë£¹ ({{ group|length }}ì¥)</div>
          <div class="group-images">
            {% for name in group %}
              {% if album_images and album_images.get(name) %}
                <img src="{{ album_images.get(name) }}" alt="{{ name }}">
              {% else %}
                <img src="{{ url_for('uploaded_source_file', filename=name) }}" alt="{{ name }}">
              {% endif %}
            {% endfor %}
          </div>
        </div>
      {% endfor %}
    {% endif %}
  {% else %}
    <p>ìœ ì‚¬ ê·¸ë£¹ ì—†ìŒ</p>
  {% endif %}

  {# ----------------------------------------------------
     3) ì–¼êµ´ íƒœê·¸ + ê°ì²´ ì¸ì‹ ê²°ê³¼
     ë‘ í˜•íƒœ ëª¨ë‘ í‘œì‹œ:
       (A) per-image ë°©ì‹: tag_results = tag_and_detect["results"]
       (B) ì¸ë¬¼ë³„ ë¬¶ìŒ: tagged_images_by_person (ë˜ëŠ” tagged_images)
     íƒœê¹… ì¸ë„¤ì¼ì€ base64 ë˜ëŠ” ì„œë²„ ì €ì¥ íŒŒì¼ ê²½ë¡œë¡œ í‘œì‹œ
     ---------------------------------------------------- #}
  <h2>ğŸ·ï¸ íƒœê¹…/ê°ì²´ ì¸ì‹ ê²°ê³¼</h2>

  {# (A) per-image ìƒì„¸ #}
  {% if tag_results %}
    {% for it in tag_results %}
      <div class="card">
        <div class="row">
          <div>
            <span class="chip">ì´ë¯¸ì§€</span> <b>{{ it.image_name }}</b>
          </div>
          <div class="muted">
            ì–¼êµ´ {{ it.total_faces }}ê°œ
            {% if it.faces %} Â· ë§¤ì¹­ {{ it.faces|length }}ê°œ{% endif %}
            {% if it.objects %} Â· ê°ì²´ {{ it.objects|length }}ê°œ{% endif %}
          </div>
        </div>
        <div class="thumbs" style="margin-top:8px">
          {% set img_src = None %}
          {% if it.tagged_image_base64 %}
            {% set img_src = "data:image/jpeg;base64," + it.tagged_image_base64 %}
          {% elif it.tagged_image_path %}
            {# íŒŒì¼ ì‹œìŠ¤í…œ ê²½ë¡œë¼ë©´ ì§ì ‘ ì„œë¹™ ë¼ìš°íŠ¸ê°€ ìˆì–´ì•¼ í•¨(ì˜ˆ: /uploads/tagged_results/<fn>) #}
            {% set img_src = it.tagged_image_path %}
          {% elif it.tagged_image_filename %}
            {% set img_src = url_for('static', filename='results/' + it.tagged_image_filename) %}
          {% elif album_images and album_images.get(it.image_name) %}
            {% set img_src = album_images.get(it.image_name) %}
          {% endif %}

          {% if img_src %}
            <img src="{{ img_src }}" alt="{{ it.image_name }}">
          {% endif %}
        </div>

        {% if it.faces %}
          <div class="kv"><b>Faces:</b>
            {% for f in it.faces %}
              {{ f.person_name }} ({{ "%.2f"|format(f.distance) }}){% if not loop.last %}, {% endif %}
            {% endfor %}
          </div>
        {% endif %}
        {% if it.objects %}
          <div class="kv"><b>Objects:</b>
            {% for o in it.objects %}
              {{ o.label }} ({{ "%.2f"|format(o.conf) }}){% if not loop.last %}, {% endif %}
            {% endfor %}
          </div>
        {% endif %}
      </div>
    {% endfor %}
  {% else %}
    <p class="muted">ë°°ì¹˜ íƒœê¹… ê²°ê³¼ê°€ ì•„ì§ ì—†ìŠµë‹ˆë‹¤.</p>
  {% endif %}

  {# (B) ì¸ë¬¼ë³„ ë¬¶ìŒ (ë ˆê±°ì‹œ í˜¸í™˜) #}
  {% set person_map = tagged_images_by_person if tagged_images_by_person else tagged_images %}
  {% if person_map %}
    <h3>ğŸ‘¤ ì¸ë¬¼ë³„ íƒœê·¸ ì´ë¯¸ì§€</h3>
    {% for name, images in person_map.items() %}
      <div class="group-box">
        <div class="group-title">ì¸ë¬¼: {{ name }}</div>
        <div class="tagged">
          {% for fn in images %}
            {# ìƒˆ êµ¬ì¡°ì—ì„  íŒŒì¼ëª…ì´ ì•„ë‹Œ ì›ë³¸ nameì¼ ìˆ˜ ìˆìŒ â†’ album_images í´ë°± #}
            {% if album_images and album_images.get(fn) %}
              <img src="{{ album_images.get(fn) }}" alt="{{ fn }}">
            {% else %}
              <img src="{{ url_for('static', filename='results/' + fn) }}" alt="{{ fn }}">
            {% endif %}
          {% endfor %}
        </div>
      </div>
    {% endfor %}
  {% endif %}
</body>
</html>
